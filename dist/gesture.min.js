/**
 * @license MIT
 * @author abcrun
 **/
!function(e,t){"function"==typeof define&&define.amd?define(t):"object"==typeof module&&module.exports?module.exports=t():e.Besom=t()}(this,function(){function f(e){return Math.round(1e3*parseFloat(e))/1e3}function u(e){this.element=e,this.resetTransform()}var m={create:function(e){if("string"==typeof e){var t=(/matrix\((.*)\)/.exec(e)||["",""])[1].split(",");e=6<=t.length?[[f(t[0]),f(t[2]),f(t[4])],[f(t[1]),f(t[3]),f(t[5])],[0,0,1]]:[[1,0,0],[0,1,0],[0,0,1]]}else{var n=e.translate||0,a=e.scale.x||1,r=(r=e.rotate||0)*Math.PI/180,s=f(Math.sin(r)),o=f(Math.cos(r));e=this.mutiply(this.mutiply([[1,0,n.x],[0,1,n.y],[0,0,1]],[[o,-s,0],[s,o,0],[0,0,1]]),[[a,0,0],[0,a,0],[0,0,1]])}return e},mutiply:function(e,t){for(var n=[],a=0;a<e.length;a++){for(var r=[],s=0;s<t[a].length;s++)r.push(f(e[a][0]*t[0][s]+e[a][1]*t[1][s]+e[a][2]*t[2][s]));n.push(r)}return n},parse:function(e){var t=e[0][0],n=e[1][0],a=e[0][1],r=e[1][1],s=e[0][2],o=e[1][2],i=Math.atan2(n,t)*(180/Math.PI),l=-Math.PI/180*i;return{scale:{x:f(Math.sqrt(t*t+n*n)),y:f(Math.sqrt(a*a+r*r))},rotate:f(i),translate:{x:f(Math.cos(l)*s-Math.sin(l)*o),y:f(Math.sin(l)*s+Math.cos(l)*o)}}}};u.prototype={offset:function(){for(var e=(n=this.element).offsetLeft,t=n.offsetTop;n.offsetParent;){var n;e+=(n=n.offsetParent).offsetLeft,t+=n.offsetTop}return{left:e,top:t}},resetTransform:function(){var e=window.getComputedStyle(this.element,!1),t=m.create("none"!=e.transform?e.transform:"matrix(1,0,0,1,0,0)"),n=e["transform-origin"].split(" "),a=(m.parse(t),f(n[0])),r=f(n[1]);this.transform={matrix:t,json:m.parse(t),origin:{x:a,y:r}}},getPointOrigin:function(e){var t,n,a=this.offset(),r=e.pageX-a.left,s=e.pageY-a.top,o=this.transform,i=Math.PI/180,l=o.json,h=o.origin,c=l.rotate,u=l.scale.x,f=l.translate,m=f.x,v=f.y,d=h.x-r,p=h.y-s,g=Math.sqrt(d*d+p*p)/u,x=Math.atan(Math.abs(p/d))/i;0<p&&0<d&&(toangle=x-c),0<p&&d<0&&(toangle=180-x-c),p<0&&0<d&&(toangle=x+c),p<0&&d<0&&(toangle=x-c);var y=g*Math.cos(toangle*i),b=g*Math.sin(toangle*i);return 0<p&&0<d&&(t=h.x-y)&&(n=h.y-b),0<p&&d<0&&(t=h.x-y)&&(n=h.y-b),p<0&&0<d&&(t=h.x-y)&&(n=h.y+b),p<0&&d<0&&(t=h.x+y)&&(n=h.y+b),{x:t-m/u,y:n-v/u}},setOrigin:function(e){var t=this.transform,n=t.matrix,a=t.origin,r=a.x-e.x,s=a.y-e.y,o=[[-r],[-s],[1]],i=m.mutiply(n,o),l=i[0][0]+a.x,h=i[1][0]+a.y,c=r+(l-a.x),u=s-(a.y-h);this.render({translate:{x:c,y:u},origin:e}),this.resetTransform()},translate:function(e,t){var n=this.transform.matrix,a=n[0][2],r=n[1][2],s={x:a+e.x,y:r+e.y};this.render({translate:s},t),this.resetTransform()},scale:function(e,t){var n=e*this.transform.json.scale.x;this.render({scale:n},t),this.resetTransform()},rotate:function(e,t){var n=this.transform.json.rotate+e;this.render({rotate:n},t),this.resetTransform()},render:function(e,t){var n=this.element,a=n.style.cssText||"",r=this.transform,s=r.matrix,o=r.json,i=e.origin||r.origin,l=(t=t||"0s",e.translate||{x:s[0][2],y:s[1][2]}),h=f(e.scale||o.scale.x),c=f(e.rotate||o.rotate),u=(t="-webkit-transition:"+t+";","-webkit-transform: translate("+f(l.x)+"px, "+f(l.y)+"px) scale("+h+") rotate("+c+"deg);");i="-webkit-transform-origin:"+i.x+"px "+i.y+"px;";n.style.cssText=a+";"+t+u+i}};function b(e,t){var n=t.pageX-e.pageX,a=t.pageY-e.pageY;return{offsetx:n,offsety:a,length:Math.sqrt(n*n+a*a)}}function w(e){var t=e.touches&&e.touches.length?e.touches:e.changedTouches&&e.changedTouches.length?e.changedTouches:[e],n={time:(new Date).getTime(),count:t.length,event:t};if(2==t.length){var a=t[0],r=t[1],s=r.pageX-a.pageX,o=r.pageY-a.pageY,i=Math.sqrt(s*s+o*o),l=Math.sqrt(i*i/4-o*o/4),h=a.pageY+o/2,c=a.pageX+(s<0?-l:l);n.length=i,n.center={pageX:c,pageY:h}}return n}function M(e,t,n,a){var r=[t,n,a],s=this.events,o=a.event[0].target,i=o.getAttribute("gid");if(i)var l=(h=s[i]||{})[e];else for(key in s){var h,c=(h=s[key]).className||"";if(-1<o.className.split(" ").indexOf(c)){v(o,key),l=h[e];break}}l&&l.apply(new u(o),r)}function n(){function c(e){return-1<v.enabled.indexOf(e)}function e(e){if(e.preventDefault(),2==(u=w(e)).count){var t=u.center,n=v.element.getPointOrigin(t);v.element.setOrigin(n)}M.call(v,"start",null,u,u),d.addEventListener(_?"touchmove":"mousemove",x,!1),d.addEventListener(_?"touchend":"mouseup",y,!1),d.addEventListener(_?"touchcancel":"mouseleave",y,!1)}var u,f,m,v=this,d=this.element.element,o=function(){if(f){var e=u.event[0],t=f.event[0],n=b(e,t),a=n.offsetx,r=n.offsety,s={x:a-g.x,y:r-g.y};g={x:a,y:r},v.onlydetect||v.element.translate(s,0),M.call(v,"slide",s,f,u),T(o)}},a=function(){if(f&&2==f.count&&2==u.count){var e=v.element.transform.json.scale.x,t=u.length,n=f.length/t;v.onlydetect||v.element.scale(n,0),M.call(v,"pinch",{preScale:e,increase:n,nextScale:n*e},f,u),T(a)}},p=function(){if(f&&2==f.count&&2==u.count){var e=v.element.transform.json.rotate,t=u.event,n=f.event,a=u.length,r=f.length,s=Math.PI/180,o=b(n[0],t[0]),i=b(n[1],t[1]),l=o.length+i.length,h=(a*a+r*r-l*l)/(2*a*r),c=Math.acos(h<-1?-1:1<h?1:h)/s;v.onlydetect||v.element.rotate(c,0),M.call(v,"rotate",{preRotate:e,nextRotate:e+c,increase:c},f,u),T(p)}},g={x:0,y:0},x=function(e){e.preventDefault(),f=w(e),c("slide")&&1==f.count&&1==u.count&&(m||T(o)),(c("pinch")||c("rotate"))&&2==f.count&&2==u.count&&(c("pinch")?m||T(a):m||T(p)),m=m||!0},y=function(e){var t,n=u.event,a=w(e),r=a.event,s=a.time-u.time,o={duration:s};if(e.preventDefault(),!e.touches||0==e.touches.length){if(1==u.count){var i=b(n[0],r[0]),l=i.offsetx,h=i.offsety;Math.abs(l)<3&&Math.abs(h)<3?function(e,t,n){var a=this,r=this.__lastTouch,s=r&&t.time-r.time<300?"doubletap":e<200?"tap":"longtap";if("tap"==s&&(this.__lastTouch=t),setTimeout(function(){a.__lastTouch=null},300),"tap"==s&&c("doubletap")){var o=setTimeout(function(){M.call(a,"tap",{duration:e},t,n)},300);this.__lastTouch.itv=o}else r&&r.itv&&clearTimeout(r.itv),c(s)&&M.call(this,s,{duration:e},t,n)}.call(v,s,a,u):t="slide"}else t=c("pinch")?"pinch":c("rotate")?"rotate":void 0;v.element.resetTransform(),t&&M.call(v,t+"End",o,a,u),f=null,m=void 0,g={x:0,y:0},d.removeEventListener(_?"touchmove":"mousemove",x,!1),d.removeEventListener(_?"touchend":"mouseup",y,!1),d.removeEventListener(_?"touchcancel":"mouseleave",y,!1)}};return d.addEventListener(_?"touchstart":"mousedown",e,!1),e}function a(e,t){if(e.length)throw new Error("The element parameter shouldn't be an array list. If you want to add gestures to these elements, please use delegate method of their parent element");this.element=new u(e),this.events={},this.enabled=["tap"],this.onlydetect=t||!1,this.__evtfn=n.call(this)}var r,v=(r=-1,function(e,t){var n=t||"besom_"+ ++r;return e&&e.setAttribute("gid",n),n}),T=window.requestAnimationFrame||window.webkitRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},_="ontouchend"in document;return a.prototype={enable:function(){for(var e=["tap","longtap","doubletap","slide","pinch","rotate"],t=[],n=0;n<arguments.length;n++)t.push(arguments[n]);if(-1<(t=t.concat(this.enabled)).indexOf("pinch")&&-1<t.indexOf("rotate"))throw new Error("At present, please don't both enable pinch and rotate!");for(var a=0;a<arguments.length;a++){var r=arguments[a];if(!(-1<e.indexOf(r)))throw new Error('Only Support: "'+e.join("|")+'"!');this.enabled.indexOf(r)<0&&this.enabled.push(r)}},disable:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e],n=this.enabled.indexOf(t);-1<n&&this.enabled.splice(n,1)}},on:function(e,t){var n=this.element.element.getAttribute("gid")||v(this.element.element);this.events[n]=this.events[n]||{},this.events[n][e]=t},delegate:function(e,t,n){if(e.indexOf(".")<0)throw new Error('The parameter cls shoud start width "."!');e=e.substring(1),this.onlydetect=!0;var a=v();for(key in this.events)this.events[key].className==e&&(a=key);this.events[a]=this.events[a]||{};var r=this.events[a];r[t]=n,r.className=e},destroy:function(){this.element.removeEventListener(_?"touchstart":"mousedown",this.__evtfn,!1),this.__evtfn,this.element=null,this.events={},this.onlydetect=!1}},{create:function(e,t){return new a(e,t||!1)},element:function(e){return new u(e)}}});