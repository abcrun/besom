/**
 * @license MIT
 * @author abcrun
 **/
!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof module&&module.exports?module.exports=e():t.Besom=e()}(this,function(){function c(t){return Math.round(1e3*parseFloat(t))/1e3}function m(t){this.element=t,this.resetTransform()}var d={create:function(t){if("string"==typeof t){var e=(/matrix\((.*)\)/.exec(t)||["",""])[1].split(",");t=6<=e.length?[[c(e[0]),c(e[2]),c(e[4])],[c(e[1]),c(e[3]),c(e[5])],[0,0,1]]:[[1,0,0],[0,1,0],[0,0,1]]}else{var n=t.translate||0,a=t.scale.x||1,r=(r=t.rotate||0)*Math.PI/180,s=c(Math.sin(r)),i=c(Math.cos(r));t=this.mutiply(this.mutiply([[1,0,n.x],[0,1,n.y],[0,0,1]],[[i,-s,0],[s,i,0],[0,0,1]]),[[a,0,0],[0,a,0],[0,0,1]])}return t},mutiply:function(t,e){for(var n=[],a=0;a<t.length;a++){for(var r=[],s=0;s<e[a].length;s++)r.push(c(t[a][0]*e[0][s]+t[a][1]*e[1][s]+t[a][2]*e[2][s]));n.push(r)}return n},parse:function(t){var e=t[0][0],n=t[1][0],a=t[0][1],r=t[1][1],s=t[0][2],i=t[1][2],o=Math.atan2(n,e)*(180/Math.PI),l=-Math.PI/180*o;return{scale:{x:c(Math.sqrt(e*e+n*n)),y:c(Math.sqrt(a*a+r*r))},rotate:c(o),translate:{x:c(Math.cos(l)*s-Math.sin(l)*i),y:c(Math.sin(l)*s+Math.cos(l)*i)}}}};m.prototype={offset:function(){for(var t=(n=this.element).offsetLeft,e=n.offsetTop;n.offsetParent;){var n;t+=(n=n.offsetParent).offsetLeft,e+=n.offsetTop}return{left:t,top:e}},resetTransform:function(){var t=window.getComputedStyle(this.element,!1),e=d.create("none"!=t.transform?t.transform:"matrix(1,0,0,1,0,0)"),n=t["transform-origin"].split(" "),a=(d.parse(e),c(n[0])),r=c(n[1]);this.transform={matrix:e,json:d.parse(e),origin:{x:a,y:r}}},getPointOrigin:function(t){var e,n,a=this.offset(),r=t.pageX-a.left,s=t.pageY-a.top,i=this.transform,o=Math.PI/180,l=i.json,h=i.origin,u=l.rotate,f=l.scale.x,c=l.translate,m=c.x,d=c.y,g=h.x-r,p=h.y-s,v=Math.sqrt(g*g+p*p)/f,x=Math.atan(Math.abs(p/g))/o;0<p&&0<g&&(toangle=x-u),0<p&&g<0&&(toangle=180-x-u),p<0&&0<g&&(toangle=x+u),p<0&&g<0&&(toangle=x-u);var y=v*Math.cos(toangle*o),b=v*Math.sin(toangle*o);return 0<p&&0<g&&(e=h.x-y)&&(n=h.y-b),0<p&&g<0&&(e=h.x-y)&&(n=h.y-b),p<0&&0<g&&(e=h.x-y)&&(n=h.y+b),p<0&&g<0&&(e=h.x+y)&&(n=h.y+b),{x:e-m/f,y:n-d/f}},setOrigin:function(t){var e=this.transform,n=e.matrix,a=e.origin,r=a.x-t.x,s=a.y-t.y,i=[[-r],[-s],[1]],o=d.mutiply(n,i),l=o[0][0]+a.x,h=o[1][0]+a.y,u=r+(l-a.x),f=s-(a.y-h);this.render({translate:{x:u,y:f},origin:t}),this.resetTransform()},translate:function(t,e){var n=this.transform.matrix,a=n[0][2],r=n[1][2],s={x:a+t.x,y:r+t.y};this.render({translate:s},e),this.resetTransform()},scale:function(t,e){var n=t*this.transform.json.scale.x;this.render({scale:n},e),this.resetTransform()},rotate:function(t,e){var n=this.transform.json.rotate+t;this.render({rotate:n},e),this.resetTransform()},render:function(t,e){var n=this.element,a=n.style.cssText||"",r=this.transform,s=r.matrix,i=r.json,o=t.origin||r.origin,l=(e=e||"0s",t.translate||{x:s[0][2],y:s[1][2]}),h=c(t.scale||i.scale.x),u=c(t.rotate||i.rotate),f=(e="-webkit-transition:"+e+";","-webkit-transform: translate("+c(l.x)+"px, "+c(l.y)+"px) scale("+h+") rotate("+u+"deg);");o="-webkit-transform-origin:"+o.x+"px "+o.y+"px;";n.style.cssText=a+";"+e+f+o}};function b(t,e){var n=e.pageX-t.pageX,a=e.pageY-t.pageY;return{offsetx:n,offsety:a,length:Math.sqrt(n*n+a*a)}}function M(t){var e=t.touches&&t.touches.length?t.touches:t.changedTouches&&t.changedTouches.length?t.changedTouches:[t],n={time:(new Date).getTime(),count:e.length,event:e};if(2==e.length){var a=e[0],r=e[1],s=r.pageX-a.pageX,i=r.pageY-a.pageY,o=Math.sqrt(s*s+i*i),l=Math.sqrt(o*o/4-i*i/4),h=a.pageY+i/2,u=a.pageX+(s<0?-l:l);n.length=o,n.center={pageX:u,pageY:h}}return n}function w(t,e,n,a){var r,s=[e,n,a],i=(this.events,this.element.element),o=a.event[0].target,l=this.delegates[t];if(l)t:for(;o!=i;){var h=o.getAttribute("__gid");if(h){r=l[h];break t}var u=(o.className||"").split(" ");e:for(var f=0;f<u.length;f++){var c=u[f];if(c&&l[c]){o.setAttribute("__gid",c),r=l[c];break e}}if(r)break t;o=o.parentNode}r?r.apply(new m(o),s):this.events[t]&&this.events[t].apply(this.element,s)}function n(){function h(t){return-1<v.enabled.indexOf(t)}function t(t){if(t.preventDefault(),2==(g=M(t)).count){var e=g.center,n=v.element.getPointOrigin(e);v.element.setOrigin(n)}w.call(v,"start",null,g,g),f.addEventListener(_?"touchmove":"mousemove",c,!1),f.addEventListener(_?"touchend":"mouseup",y,!1),f.addEventListener(_?"touchcancel":"mouseleave",y,!1)}var m,d,g,p,u,v=this,f=this.element.element,i=function(){if(p){m=m||{x:0,y:0};var t=g.event[0],e=p.event[0],n=b(t,e),a=n.offsetx,r=n.offsety,s={x:a,y:r};v.onlydetect||v.element.translate({x:s.x-m.x,y:s.y-m.y},0),w.call(v,"slide",{increase:{x:s.x-m.x,y:s.y-m.y},total:s},p,g),m={x:a,y:r},T(i)}},x=function(){if(p&&2==p.count&&2==g.count){var t=g.event,e=p.event,n=g.length,a=p.length,r=Math.PI/180,s=a/n,i=b(e[0],t[0]),o=b(e[1],t[1]),l=i.length+o.length,h=(n*n+a*a-l*l)/(2*n*a),u=Math.acos(h<-1?-1:1<h?1:h)/r;if(d=null==d?.01<Math.abs(s-1)||Math.abs(u)<.2:d){var f=s/(m=m||1);v.onlydetect||v.element.scale(f,0),w.call(v,"pinch",{increase:f,total:s},p,g),m=s}else{m=m||0;var c=t[0].pageY<t[1].pageY?0:1;f=(u=(0<=e[c].pageX-t[c].pageX?1:-1)*u)-m;v.onlydetect||v.element.rotate(f,0),w.call(v,"rotate",{increase:f,total:u},p,g),m=u}T(x)}},c=function(t){t.preventDefault(),p=M(t),u||(h("slide")&&1==p.count&&1==g.count&&T(i),(h("pinch")||h("rotate"))&&2==p.count&&2==g.count&&(d=!!h("pinch")&&(!h("rotate")||void 0),T(x)),u=!0)},y=function(t){var e,n=g.event,a=M(t),r=a.event,s=a.time-g.time;if(t.preventDefault(),!t.touches||0==t.touches.length){if(1==g.count){var i=b(n[0],r[0]),o=i.offsetx,l=i.offsety;Math.abs(o)<3&&Math.abs(l)<3?function(t,e,n){var a=this,r=this.__lastTouch,s=r&&e.time-r.time<300?"doubletap":t<200?"tap":"longtap";if("tap"==s&&(this.__lastTouch=e),setTimeout(function(){a.__lastTouch=null},300),"tap"==s&&h("doubletap")){var i=setTimeout(function(){w.call(a,"tap",{duration:t},e,n)},300);this.__lastTouch.itv=i}else r&&r.itv&&clearTimeout(r.itv),h(s)&&w.call(this,s,{duration:t},e,n)}.call(v,s,a,g):e="slide"}else e=h("pinch")?"pinch":h("rotate")?"rotate":void 0;v.element.resetTransform(),e&&w.call(v,e+"End",{duration:s,total:m},a,g),p=null,d=m=u=void 0,f.removeEventListener(_?"touchmove":"mousemove",c,!1),f.removeEventListener(_?"touchend":"mouseup",y,!1),f.removeEventListener(_?"touchcancel":"mouseleave",y,!1)}};return f.addEventListener(_?"touchstart":"mousedown",t,!1),t}function a(t,e){if(t.length)throw new Error("The element parameter shouldn't be an array list. If you want to add gestures to these elements, please use delegate method of their parent element");this.element=new m(t),this.events={},this.delegates={},this.enabled=["tap"],this.onlydetect=e||!1,this.__evtfn=n.call(this)}var T=window.requestAnimationFrame||window.webkitRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)},_="ontouchend"in document;return a.prototype={enable:function(){for(var t=["tap","longtap","doubletap","slide","pinch","rotate"],e=0;e<arguments.length;e++){var n=arguments[e];if(!(-1<t.indexOf(n)))throw new Error('Only Support: "'+t.join("|")+'"!');this.enabled.indexOf(n)<0&&this.enabled.push(n)}},getPointOrigin:function(t){this.element.getPointOrigin(t)},setOrigin:function(t){this.element.setOrigin(t)},scale:function(t,e){this.element.scale(t,e)},rotate:function(t,e){this.element.rotate(t,e)},translate:function(t,e){this.element.translate(t,e)},disable:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t],n=this.enabled.indexOf(e);-1<n&&this.enabled.splice(n,1)}},on:function(t,e){this.events[t]=e},delegate:function(t,e,n){if(t.indexOf(".")<0)throw new Error('The parameter cls shoud start width "."!');t=t.substring(1),this.onlydetect=!0,this.delegates[e]=this.delegates[e]||{},this.delegates[e][t]=n},destroy:function(){this.element.removeEventListener(_?"touchstart":"mousedown",this.__evtfn,!1),this.__evtfn,this.element=null,this.events={},this.delegates={},this.onlydetect=!1}},{create:function(t,e){return new a(t,e||!1)},element:function(t){return new m(t)}}});