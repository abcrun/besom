/**
 * @license MIT
 * @author abcrun
 **/
!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof module&&module.exports?module.exports=e():t.Besom=e()}(this,function(){function f(t){return Math.round(1e3*parseFloat(t))/1e3}function c(t){this.element=t,this.resetTransform()}var m={create:function(t){if("string"==typeof t){var e=(/matrix\((.*)\)/.exec(t)||["",""])[1].split(",");t=6<=e.length?[[f(e[0]),f(e[2]),f(e[4])],[f(e[1]),f(e[3]),f(e[5])],[0,0,1]]:[[1,0,0],[0,1,0],[0,0,1]]}else{var n=t.translate||0,a=t.scale.x||1,r=(r=t.rotate||0)*Math.PI/180,s=f(Math.sin(r)),o=f(Math.cos(r));t=this.mutiply(this.mutiply([[1,0,n.x],[0,1,n.y],[0,0,1]],[[o,-s,0],[s,o,0],[0,0,1]]),[[a,0,0],[0,a,0],[0,0,1]])}return t},mutiply:function(t,e){for(var n=[],a=0;a<t.length;a++){for(var r=[],s=0;s<e[a].length;s++)r.push(f(t[a][0]*e[0][s]+t[a][1]*e[1][s]+t[a][2]*e[2][s]));n.push(r)}return n},parse:function(t){var e=t[0][0],n=t[1][0],a=t[0][1],r=t[1][1],s=t[0][2],o=t[1][2],i=Math.atan2(n,e)*(180/Math.PI),l=-Math.PI/180*i;return{scale:{x:f(Math.sqrt(e*e+n*n)),y:f(Math.sqrt(a*a+r*r))},rotate:f(i),translate:{x:f(Math.cos(l)*s-Math.sin(l)*o),y:f(Math.sin(l)*s+Math.cos(l)*o)}}}};c.prototype={offset:function(){for(var t=(n=this.element).offsetLeft,e=n.offsetTop;n.offsetParent;){var n;t+=(n=n.offsetParent).offsetLeft,e+=n.offsetTop}return{left:t,top:e}},resetTransform:function(){var t=window.getComputedStyle(this.element,!1),e=m.create("none"!=t.transform?t.transform:"matrix(1,0,0,1,0,0)"),n=t["transform-origin"].split(" "),a=(m.parse(e),f(n[0])),r=f(n[1]);this.transform={matrix:e,json:m.parse(e),origin:{x:a,y:r}}},getPointOrigin:function(t){var e,n,a=this.offset(),r=t.pageX-a.left,s=t.pageY-a.top,o=this.transform,i=Math.PI/180,l=o.json,h=o.origin,u=l.rotate,c=l.scale.x,f=l.translate,m=f.x,v=f.y,d=h.x-r,p=h.y-s,g=Math.sqrt(d*d+p*p)/c,y=Math.atan(Math.abs(p/d))/i;0<p&&0<d&&(toangle=y-u),0<p&&d<0&&(toangle=180-y-u),p<0&&0<d&&(toangle=y+u),p<0&&d<0&&(toangle=y-u);var x=g*Math.cos(toangle*i),b=g*Math.sin(toangle*i);return 0<p&&0<d&&(e=h.x-x)&&(n=h.y-b),0<p&&d<0&&(e=h.x-x)&&(n=h.y-b),p<0&&0<d&&(e=h.x-x)&&(n=h.y+b),p<0&&d<0&&(e=h.x+x)&&(n=h.y+b),{x:e-m/c,y:n-v/c}},setOrigin:function(t){var e=this.transform,n=e.matrix,a=e.origin,r=a.x-t.x,s=a.y-t.y,o=[[-r],[-s],[1]],i=m.mutiply(n,o),l=i[0][0]+a.x,h=i[1][0]+a.y,u=r+(l-a.x),c=s-(a.y-h);this.render({translate:{x:u,y:c},origin:t}),this.resetTransform()},translate:function(t,e){var n=this.transform.matrix,a=n[0][2],r=n[1][2],s={x:a+t.x,y:r+t.y};this.render({translate:s},e),this.resetTransform()},scale:function(t,e){var n=t*this.transform.json.scale.x;this.render({scale:n},e),this.resetTransform()},rotate:function(t,e){var n=this.transform.json.rotate+t;this.render({rotate:n},e),this.resetTransform()},render:function(t,e){var n=this.element,a=n.style.cssText||"",r=this.transform,s=r.matrix,o=r.json,i=t.origin||r.origin,l=(e=e||"0s",t.translate||{x:s[0][2],y:s[1][2]}),h=f(t.scale||o.scale.x),u=f(t.rotate||o.rotate),c=(e="-webkit-transition:"+e+";","-webkit-transform: translate("+f(l.x)+"px, "+f(l.y)+"px) scale("+h+") rotate("+u+"deg);");i="-webkit-transform-origin:"+i.x+"px "+i.y+"px;";n.style.cssText=a+";"+e+c+i}};function b(t,e){var n=e.pageX-t.pageX,a=e.pageY-t.pageY;return{offsetx:n,offsety:a,length:Math.sqrt(n*n+a*a)}}function M(t){var e=t.touches&&t.touches.length?t.touches:t.changedTouches&&t.changedTouches.length?t.changedTouches:[t],n={time:(new Date).getTime(),count:e.length,event:e};if(2==e.length){var a=e[0],r=e[1],s=r.pageX-a.pageX,o=r.pageY-a.pageY,i=Math.sqrt(s*s+o*o),l=Math.sqrt(i*i/4-o*o/4),h=a.pageY+o/2,u=a.pageX+(s<0?-l:l);n.length=i,n.center={pageX:u,pageY:h}}return n}function w(t,e,n,a){var r=[e,n,a],s=this.events,o=a.event[0].target,i=o.getAttribute("gid");if(i)var l=(h=s[i]||{})[t];else for(key in s){var h,u=(h=s[key]).className||"";if(-1<o.className.split(" ").indexOf(u)){v(o,key),l=h[t];break}}l&&l.apply(new c(o),r)}function n(){function h(t){return-1<g.enabled.indexOf(t)}function t(t){if(t.preventDefault(),2==(d=M(t)).count){var e=d.center,n=g.element.getPointOrigin(e);g.element.setOrigin(n)}w.call(g,"start",null,d,d),c.addEventListener(_?"touchmove":"mousemove",f,!1),c.addEventListener(_?"touchend":"mouseup",x,!1),c.addEventListener(_?"touchcancel":"mouseleave",x,!1)}var m,v,d,p,u,g=this,c=this.element.element,o=function(){if(p){m=m||{x:0,y:0};var t=d.event[0],e=p.event[0],n=b(t,e),a=n.offsetx,r=n.offsety,s={x:a,y:r};g.onlydetect||g.element.translate(s,0),w.call(g,"slide",{increase:{x:s.x-m.x,y:s.y-m.y},total:s},p,d),m={x:a,y:r},T(o)}},y=function(){if(p&&2==p.count&&2==d.count){var t=d.event,e=p.event,n=d.length,a=p.length,r=Math.PI/180,s=a/n,o=b(e[0],t[0]),i=b(e[1],t[1]),l=o.length+i.length,h=(n*n+a*a-l*l)/(2*n*a),u=Math.acos(h<-1?-1:1<h?1:h)/r;if(v=null==v?.01<Math.abs(s-1)||Math.abs(u)<.2:v){var c=s/(m=m||1);g.onlydetect||g.element.scale(c,0),w.call(g,"pinch",{increase:c,total:s},p,d),m=s}else{m=m||0;var f=t[0].pageY<t[1].pageY?0:1;c=(u*=0<=e[f].pageX-t[f].pageX?1:-1)-m;g.onlydetect||g.element.rotate(c,0),w.call(g,"rotate",{increase:c,total:u},p,d),m=u}T(y)}},f=function(t){t.preventDefault(),p=M(t),u||(h("slide")&&1==p.count&&1==d.count&&T(o),(h("pinch")||h("rotate"))&&2==p.count&&2==d.count&&(v=!!h("pinch")&&(!h("rotate")||void 0),T(y)),u=!0)},x=function(t){var e,n=d.event,a=M(t),r=a.event,s=a.time-d.time;if(t.preventDefault(),!t.touches||0==t.touches.length){if(1==d.count){var o=b(n[0],r[0]),i=o.offsetx,l=o.offsety;Math.abs(i)<3&&Math.abs(l)<3?function(t,e,n){var a=this,r=this.__lastTouch,s=r&&e.time-r.time<300?"doubletap":t<200?"tap":"longtap";if("tap"==s&&(this.__lastTouch=e),setTimeout(function(){a.__lastTouch=null},300),"tap"==s&&h("doubletap")){var o=setTimeout(function(){w.call(a,"tap",{duration:t},e,n)},300);this.__lastTouch.itv=o}else r&&r.itv&&clearTimeout(r.itv),h(s)&&w.call(this,s,{duration:t},e,n)}.call(g,s,a,d):e="slide"}else e=h("pinch")?"pinch":h("rotate")?"rotate":void 0;g.element.resetTransform(),e&&w.call(g,e+"End",{duration:s,total:m},a,d),p=null,v=m=u=void 0,c.removeEventListener(_?"touchmove":"mousemove",f,!1),c.removeEventListener(_?"touchend":"mouseup",x,!1),c.removeEventListener(_?"touchcancel":"mouseleave",x,!1)}};return c.addEventListener(_?"touchstart":"mousedown",t,!1),t}function a(t,e){if(t.length)throw new Error("The element parameter shouldn't be an array list. If you want to add gestures to these elements, please use delegate method of their parent element");this.element=new c(t),this.events={},this.enabled=["tap"],this.onlydetect=e||!1,this.__evtfn=n.call(this)}var r,v=(r=-1,function(t,e){var n=e||"besom_"+ ++r;return t&&t.setAttribute("gid",n),n}),T=window.requestAnimationFrame||window.webkitRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)},_="ontouchend"in document;return a.prototype={enable:function(){for(var t=["tap","longtap","doubletap","slide","pinch","rotate"],e=0;e<arguments.length;e++){var n=arguments[e];if(!(-1<t.indexOf(n)))throw new Error('Only Support: "'+t.join("|")+'"!');this.enabled.indexOf(n)<0&&this.enabled.push(n)}},disable:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t],n=this.enabled.indexOf(e);-1<n&&this.enabled.splice(n,1)}},on:function(t,e){var n=this.element.element.getAttribute("gid")||v(this.element.element);this.events[n]=this.events[n]||{},this.events[n][t]=e},delegate:function(t,e,n){if(t.indexOf(".")<0)throw new Error('The parameter cls shoud start width "."!');t=t.substring(1),this.onlydetect=!0;var a=v();for(key in this.events)this.events[key].className==t&&(a=key);this.events[a]=this.events[a]||{};var r=this.events[a];r[e]=n,r.className=t},destroy:function(){this.element.removeEventListener(_?"touchstart":"mousedown",this.__evtfn,!1),this.__evtfn,this.element=null,this.events={},this.onlydetect=!1}},{create:function(t,e){return new a(t,e||!1)},element:function(t){return new c(t)}}});